#!/usr/bin/env php
<?php

/**
 * リリースノートから readme.txt の Changelog セクションを自動生成するスクリプト。
 */

declare(strict_types=1);

if ( ! function_exists( 'esc_html' ) ) {
	/**
	 * WordPress が読み込まれていない CLI 実行時用の簡易 HTML エスケープ。
	 *
	 * @param string $text エスケープ対象の文字列。
	 * @return string エスケープ済み文字列。
	 */
	function esc_html( string $text ): string {
		return htmlspecialchars( $text, ENT_QUOTES | ENT_SUBSTITUTE, 'UTF-8' );
	}
}

$release_notes_dir = __DIR__ . '/../docs/release-notes';
$readme_path       = __DIR__ . '/../readme.txt';

$files = glob( $release_notes_dir . '/v*.md' );
if ( false === $files || array() === $files ) {
	// リリースノートがない場合は何もせず正常終了（新リポジトリ初期状態を考慮）
	echo "リリースノートがありません。Changelog は更新されませんでした。\n";
	exit( 0 );
}

/**
 * リリースノートからバージョンとセクション情報を抽出する。
 *
 * @param string $path リリースノートのパス。
 * @return array{version:string,sections:array<string,array<int,string>>}
 */
function parse_release_note( string $path ): array {
	$version = parse_version_from_path( $path );
	$lines   = file( $path, FILE_IGNORE_NEW_LINES );

	if ( false === $lines ) {
		throw new RuntimeException( 'ファイルを読み込めません: ' . esc_html( $path ) );
	}

	$sections        = array();
	$current_heading = '';

	foreach ( $lines as $line ) {
		$trimmed = trim( $line );

		if ( 1 === preg_match( '/^##\s+(.+)$/u', $trimmed, $heading_match ) ) {
			$current_heading              = $heading_match[1];
			$sections[ $current_heading ] = $sections[ $current_heading ] ?? array();
			continue;
		}

		if ( str_starts_with( $trimmed, '- ' ) ) {
			$content = trim( substr( $trimmed, 2 ) );

			if ( '' !== $content ) {
				$sections[ $current_heading ]   = $sections[ $current_heading ] ?? array();
				$sections[ $current_heading ][] = $content;
			}
		}
	}

	return array(
		'version'  => $version,
		'sections' => $sections,
	);
}

/**
 * ファイル名または先頭見出しからバージョンを抽出する。
 *
 * @param string $path リリースノートのパス。
 * @return string バージョン文字列。
 */
function parse_version_from_path( string $path ): string {
	$basename = basename( $path );
	if ( 1 === preg_match( '/v([0-9]+\.[0-9]+\.[0-9]+)/', $basename, $matches ) ) {
		return $matches[1];
	}

	$lines = file( $path, FILE_IGNORE_NEW_LINES );
	if ( false === $lines ) {
		throw new RuntimeException( 'ファイルを読み込めません: ' . esc_html( $path ) );
	}

	foreach ( $lines as $line ) {
		if ( 1 === preg_match( '/v([0-9]+\.[0-9]+\.[0-9]+)/', $line, $matches ) ) {
			return $matches[1];
		}
	}

	throw new RuntimeException( 'バージョンを抽出できません: ' . esc_html( $path ) );
}

$entries = array_map( 'parse_release_note', $files );

usort(
	$entries,
	static function ( array $a, array $b ): int {
		return version_compare( $b['version'], $a['version'] );
	}
);

$changelog_lines   = array( '<!-- Generated by bin/generate-changelog.php -->' );
$changelog_lines[] = '';

foreach ( $entries as $entry ) {
	$changelog_lines[] = '= ' . $entry['version'] . ' =';

	foreach ( $entry['sections'] as $heading => $items ) {
		if ( array() === $items ) {
			continue;
		}

		foreach ( $items as $item ) {
			$label             = '' !== $heading ? '[' . $heading . '] ' : '';
			$changelog_lines[] = '* ' . $label . $item;
		}
	}

	$changelog_lines[] = '';
}

$readme_lines = file( $readme_path, FILE_IGNORE_NEW_LINES );

if ( false === $readme_lines ) {
// phpcs:ignore WordPress.WP.AlternativeFunctions.file_system_operations_fwrite
	fwrite( STDERR, "readme.txt を読み込めませんでした。\n" );
	exit( 1 );
}

$start_index = array_search( '== Changelog ==', $readme_lines, true );
$end_index   = array_search( '== Upgrade Notice ==', $readme_lines, true );

if ( false === $start_index || false === $end_index || $end_index <= $start_index ) {
// phpcs:ignore WordPress.WP.AlternativeFunctions.file_system_operations_fwrite
	fwrite( STDERR, "readme.txt に必要なセクションが見つかりません。\n" );
	exit( 1 );
}

$before = array_slice( $readme_lines, 0, $start_index + 1 );
$after  = array_slice( $readme_lines, $end_index );

$new_readme = array_merge( $before, $changelog_lines, $after );

// phpcs:ignore WordPress.WP.AlternativeFunctions.file_system_operations_file_put_contents
file_put_contents( $readme_path, implode( "\n", $new_readme ) . "\n" );

echo "Changelog を更新しました。\n";
