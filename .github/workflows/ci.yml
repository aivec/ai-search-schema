name: CI

on:
  push:
    branches: ["main", "dev", "v1.0.0"]
  pull_request:
    branches: ["main", "dev", "v1.0.0"]

jobs:
  # ---------------------------------------------------------------------------
  # README/readme.txt 同期確認
  # ---------------------------------------------------------------------------
  readme-sync:
    name: README 同期確認
    runs-on: ubuntu-latest
    steps:
      - name: リポジトリをチェックアウト
        uses: actions/checkout@v4

      - name: PHP をセットアップ
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          coverage: none
          tools: composer

      - name: Composer 依存をインストール
        run: composer install --prefer-dist --no-progress --no-interaction

      - name: README を同期
        run: composer readme:sync

      - name: README と readme.txt の差分を検査
        run: git diff --exit-code README.md readme.txt

  # ---------------------------------------------------------------------------
  # PHPCS lint
  # ---------------------------------------------------------------------------
  lint:
    name: PHPCS lint
    runs-on: ubuntu-latest
    needs: readme-sync
    steps:
      - name: リポジトリをチェックアウト
        uses: actions/checkout@v4

      - name: PHP をセットアップ
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          coverage: none
          tools: composer

      - name: Composer 依存をインストール
        run: composer install --prefer-dist --no-progress --no-interaction

      - name: PHPCS を実行
        run: composer run lint

  # ---------------------------------------------------------------------------
  # Plugin Check (WP.org guidelines)
  # ---------------------------------------------------------------------------
  plugin-check:
    name: Plugin Check
    runs-on: ubuntu-latest
    needs: lint
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: wordpress
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping -h 127.0.0.1 -proot"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5
    steps:
      - name: リポジトリをチェックアウト
        uses: actions/checkout@v4

      - name: PHP をセットアップ
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: mysqli
          coverage: none
          tools: composer, wp-cli

      - name: Composer 依存をインストール
        run: composer install --prefer-dist --no-progress --no-interaction

      - name: WordPress を準備
        run: |
          mkdir -p /tmp/wordpress
          wp core download --path=/tmp/wordpress --version=latest
          wp config create \
            --path=/tmp/wordpress \
            --dbname=wordpress \
            --dbuser=root \
            --dbpass=root \
            --dbhost=127.0.0.1:3306 \
            --skip-check
          wp core install \
            --path=/tmp/wordpress \
            --url=http://example.test \
            --title="AI Search Schema CI" \
            --admin_user=admin \
            --admin_password=password \
            --admin_email=admin@example.com \
            --skip-email

      - name: Plugin Check を実行
        run: |
          wp plugin install plugin-check --activate --path=/tmp/wordpress
          ln -s "$GITHUB_WORKSPACE" /tmp/wordpress/wp-content/plugins/aivec-ai-search-schema
          wp plugin check aivec-ai-search-schema --skip-plugins --skip-themes --path=/tmp/wordpress

  test:
    name: PHPUnit (PHP ${{ matrix.php-version }})
    runs-on: ubuntu-latest
    needs: lint
    strategy:
      fail-fast: false
      matrix:
        php-version: ['8.0', '8.1', '8.2', '8.3', '8.4']
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: wordpress
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping -h 127.0.0.1 -proot"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5
    steps:
      - name: リポジトリをチェックアウト
        uses: actions/checkout@v4

      - name: PHP をセットアップ
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ matrix.php-version }}
          extensions: mysqli
          coverage: none
          tools: composer

      - name: 必要なパッケージをインストール
        run: sudo apt-get update && sudo apt-get install -y subversion default-mysql-client

      - name: Composer 依存をインストール
        run: composer install --prefer-dist --no-progress --no-interaction

      - name: WordPress テスト環境をセットアップ
        run: bin/install-wp-tests.sh wordpress root root 127.0.0.1:3306 latest

      - name: PHPUnit を実行
        env:
          WP_PHP_BINARY: php
        run: composer test

  coverage:
    name: カバレッジレポート (PHP 8.2)
    runs-on: ubuntu-latest
    needs: test
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: wordpress
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping -h 127.0.0.1 -proot"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5
    steps:
      - name: リポジトリをチェックアウト
        uses: actions/checkout@v4

      - name: PHP をセットアップ
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: mysqli
          coverage: xdebug
          tools: composer

      - name: 必要なパッケージをインストール
        run: sudo apt-get update && sudo apt-get install -y subversion default-mysql-client

      - name: Composer 依存をインストール
        run: composer install --prefer-dist --no-progress --no-interaction

      - name: WordPress テスト環境をセットアップ
        run: bin/install-wp-tests.sh wordpress root root 127.0.0.1:3306 latest

      - name: カバレッジ付きで PHPUnit を実行
        env:
          WP_PHP_BINARY: php
          XDEBUG_MODE: coverage
        run: composer test:coverage

      - name: カバレッジレポートをアップロード
        uses: actions/upload-artifact@v4
        with:
          name: phpunit-coverage
          path: build/coverage
