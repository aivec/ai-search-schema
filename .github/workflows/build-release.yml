# =============================================================================
# AI Search Schema - Release Build Workflow
# =============================================================================
# mainãƒ–ãƒ©ãƒ³ãƒã¸ã®pushæ™‚ã«è£½å“ZIPã‚’ãƒ“ãƒ«ãƒ‰ã—ã¦S3ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
#
# ã‚¿ã‚°å‘½åè¦å‰‡:
#   - v*.*.* (ä¾‹: v0.10.2) â†’ ãƒªãƒªãƒ¼ã‚¹ãƒ“ãƒ«ãƒ‰å®Ÿè¡Œ
#   - v*.*.*-dev (ä¾‹: v0.10.2-dev) â†’ ã‚¹ã‚­ãƒƒãƒ—ï¼ˆdevãƒ“ãƒ«ãƒ‰ç”¨ï¼‰
#
# å¿…è¦ãªGitHub Secrets:
#   AWS_ACCESS_KEY_ID     - AWSã‚¢ã‚¯ã‚»ã‚¹ã‚­ãƒ¼ID
#   AWS_SECRET_ACCESS_KEY - AWSã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚¢ã‚¯ã‚»ã‚¹ã‚­ãƒ¼
#   AWS_S3_BUCKET         - S3ãƒã‚±ãƒƒãƒˆåï¼ˆä¾‹: your-bucket-nameï¼‰
#   AWS_REGION            - AWSãƒªãƒ¼ã‚¸ãƒ§ãƒ³ï¼ˆä¾‹: ap-northeast-1ï¼‰
# =============================================================================

name: Build Release (Production)

on:
  workflow_run:
    workflows: ["CI"]
    types:
      - completed
    branches:
      - main
  push:
    tags:
      - 'v*'
      - '!v*-dev'  # -dev ã‚¿ã‚°ã¯é™¤å¤–
  workflow_dispatch:  # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½

env:
  PLUGIN_SLUG: ai-search-schema
  PHP_VERSION: '8.2'
  NODE_VERSION: '20'

jobs:
  build-and-upload:
    runs-on: ubuntu-latest
    # CI ãŒæˆåŠŸã— main ãƒ–ãƒ©ãƒ³ãƒã®å ´åˆã€ã‚¿ã‚°pushæ™‚ï¼ˆ-devé™¤ãï¼‰ã€ã¾ãŸã¯æ‰‹å‹•å®Ÿè¡Œæ™‚ã®ã¿å®Ÿè¡Œ
    if: ${{ (github.event.workflow_run.conclusion == 'success' && github.event.workflow_run.head_branch == 'main') || (github.event_name == 'push' && !contains(github.ref, '-dev')) || github.event_name == 'workflow_dispatch' }}

    steps:
      # -----------------------------------------------------------------------
      # 1. ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      # -----------------------------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_branch || github.ref }}

      # -----------------------------------------------------------------------
      # 2. PHP ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      # -----------------------------------------------------------------------
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          extensions: mbstring, xml, zip
          tools: composer:v2

      # -----------------------------------------------------------------------
      # 3. Node.js ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      # -----------------------------------------------------------------------
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      # -----------------------------------------------------------------------
      # 4. Composerä¾å­˜ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼ˆæœ¬ç•ªç”¨ï¼‰
      # -----------------------------------------------------------------------
      - name: Install Composer dependencies (production)
        run: composer install --no-dev --optimize-autoloader --no-interaction

      # -----------------------------------------------------------------------
      # 5. npmä¾å­˜ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      # -----------------------------------------------------------------------
      - name: Install npm dependencies
        run: npm ci

      # -----------------------------------------------------------------------
      # 6. ã‚¢ã‚»ãƒƒãƒˆãƒ“ãƒ«ãƒ‰
      # -----------------------------------------------------------------------
      - name: Build assets
        run: npm run build

      # -----------------------------------------------------------------------
      # 7. ãƒãƒ¼ã‚¸ãƒ§ãƒ³å–å¾—
      # -----------------------------------------------------------------------
      - name: Get plugin version
        id: version
        run: |
          VERSION=$(grep -oP "Version:\s*\K[0-9.]+" ${{ env.PLUGIN_SLUG }}.php || echo "0.0.0")
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Plugin version: $VERSION"

      # -----------------------------------------------------------------------
      # 8. Release ZIPä½œæˆï¼ˆtools/é™¤å¤–ï¼‰
      # -----------------------------------------------------------------------
      - name: Create release ZIP package
        run: |
          mkdir -p dist/${{ env.PLUGIN_SLUG }}
          
          # å¿…è¦ãªãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚³ãƒ”ãƒ¼ï¼ˆtools/ã‚’é™¤å¤–ï¼‰
          rsync -av --progress \
            --exclude='.git' \
            --exclude='.github' \
            --exclude='.gitignore' \
            --exclude='.gitattributes' \
            --exclude='node_modules' \
            --exclude='vendor' \
            --exclude='tests' \
            --exclude='phpunit.xml*' \
            --exclude='phpcs.xml*' \
            --exclude='.phpcs.xml*' \
            --exclude='composer.lock' \
            --exclude='package-lock.json' \
            --exclude='.editorconfig' \
            --exclude='.eslintrc*' \
            --exclude='.stylelintrc*' \
            --exclude='*.map' \
            --exclude='*.scss' \
            --exclude='gulpfile.js' \
            --exclude='webpack.config.js' \
            --exclude='bin/' \
            --exclude='/dist/' \
            --exclude='.claude/' \
            --exclude='ARCHITECTURE.md' \
            --exclude='CLAUDE.md' \
            --exclude='docs/' \
            --exclude='tools/' \
            ./ dist/${{ env.PLUGIN_SLUG }}/
          
          # ZIPä½œæˆ
          cd dist
          zip -r ${{ env.PLUGIN_SLUG }}-v${{ steps.version.outputs.version }}.zip ${{ env.PLUGIN_SLUG }}
          
          echo "Created: ${{ env.PLUGIN_SLUG }}-v${{ steps.version.outputs.version }}.zip"
          ls -lh *.zip

      # -----------------------------------------------------------------------
      # 9. AWSèªè¨¼
      # -----------------------------------------------------------------------
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      # -----------------------------------------------------------------------
      # 10. S3ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
      # -----------------------------------------------------------------------
      - name: Upload to S3 (release)
        run: |
          aws s3 cp \
            dist/${{ env.PLUGIN_SLUG }}-v${{ steps.version.outputs.version }}.zip \
            s3://${{ secrets.AWS_S3_BUCKET }}/aivec/plugins/${{ env.PLUGIN_SLUG }}/release/${{ env.PLUGIN_SLUG }}-v${{ steps.version.outputs.version }}.zip
          
          aws s3 cp \
            dist/${{ env.PLUGIN_SLUG }}-v${{ steps.version.outputs.version }}.zip \
            s3://${{ secrets.AWS_S3_BUCKET }}/aivec/plugins/${{ env.PLUGIN_SLUG }}/release/${{ env.PLUGIN_SLUG }}-latest.zip

      # -----------------------------------------------------------------------
      # 11. GitHub Releaseã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
      # -----------------------------------------------------------------------
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.PLUGIN_SLUG }}-v${{ steps.version.outputs.version }}
          path: dist/${{ env.PLUGIN_SLUG }}-v${{ steps.version.outputs.version }}.zip
          retention-days: 30

      # -----------------------------------------------------------------------
      # 12. ã‚µãƒžãƒªãƒ¼å‡ºåŠ›
      # -----------------------------------------------------------------------
      - name: Output summary
        run: |
          echo "## ðŸŽ‰ Release Build Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Item | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Version | ${{ steps.version.outputs.version }} |" >> $GITHUB_STEP_SUMMARY
          echo "| S3 Path | \`s3://${{ secrets.AWS_S3_BUCKET }}/${{ env.PLUGIN_SLUG }}/release/\` |" >> $GITHUB_STEP_SUMMARY
          echo "| File | ${{ env.PLUGIN_SLUG }}-v${{ steps.version.outputs.version }}.zip |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Production build (excludes \`tools/\` directory)" >> $GITHUB_STEP_SUMMARY

  # ---------------------------------------------------------------------------
  # GitHub Releaseä½œæˆï¼ˆã‚¿ã‚°pushæ™‚ã®ã¿ï¼‰
  # ---------------------------------------------------------------------------
  create-release:
    needs: build-and-upload
    if: startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get plugin version
        id: version
        run: |
          VERSION=$(grep -oP "Version:\s*\K[0-9.]+" ${{ env.PLUGIN_SLUG }}.php || echo "0.0.0")
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: ${{ env.PLUGIN_SLUG }}-v${{ steps.version.outputs.version }}

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: ${{ env.PLUGIN_SLUG }}-v${{ steps.version.outputs.version }}.zip
          generate_release_notes: true
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
