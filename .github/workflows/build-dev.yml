# =============================================================================
# AVC AEO Schema - Dev Build Workflow
# =============================================================================
# devãƒ–ãƒ©ãƒ³ãƒã¸ã®pushæ™‚ã«toolsè¾¼ã¿ZIPã‚’ãƒ“ãƒ«ãƒ‰ã—ã¦S3ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
#
# å¿…è¦ãªGitHub Secrets:
#   AWS_ACCESS_KEY_ID     - AWSã‚¢ã‚¯ã‚»ã‚¹ã‚­ãƒ¼ID
#   AWS_SECRET_ACCESS_KEY - AWSã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚¢ã‚¯ã‚»ã‚¹ã‚­ãƒ¼
#   AWS_S3_BUCKET         - S3ãƒã‚±ãƒƒãƒˆåï¼ˆä¾‹: your-bucket-nameï¼‰
#   AWS_REGION            - AWSãƒªãƒ¼ã‚¸ãƒ§ãƒ³ï¼ˆä¾‹: ap-northeast-1ï¼‰
# =============================================================================

name: Build Dev (with Tools)

on:
  workflow_run:
    workflows: ["CI"]
    types:
      - completed
    # Note: branches filter ã¯ workflow_run ã§ã¯æœŸå¾…é€šã‚Šå‹•ä½œã—ãªã„å ´åˆãŒã‚ã‚‹
    # head_branch ãƒã‚§ãƒƒã‚¯ã¯ if æ¡ä»¶ã§è¡Œã†
  workflow_dispatch:  # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½

env:
  PLUGIN_SLUG: aivec-ai-search-schema
  PHP_VERSION: '8.2'
  NODE_VERSION: '20'

jobs:
  build-and-upload:
    runs-on: ubuntu-latest
    # CI ãŒæˆåŠŸã—ã€dev ãƒ–ãƒ©ãƒ³ãƒã®å ´åˆã€ã¾ãŸã¯æ‰‹å‹•å®Ÿè¡Œæ™‚ã®ã¿å®Ÿè¡Œ
    if: ${{ (github.event.workflow_run.conclusion == 'success' && github.event.workflow_run.head_branch == 'dev') || github.event_name == 'workflow_dispatch' }}

    steps:
      # -----------------------------------------------------------------------
      # 1. ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      # -----------------------------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          # head_sha ã‚’ä½¿ç”¨ã—ã¦ CI ãŒãƒˆãƒªã‚¬ãƒ¼ã•ã‚ŒãŸæ­£ç¢ºãªã‚³ãƒŸãƒƒãƒˆã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
          # head_branch ã ã¨ãƒ–ãƒ©ãƒ³ãƒã®æœ€æ–° HEAD ãŒå–å¾—ã•ã‚Œãšã€å¤ã„ã‚³ãƒŸãƒƒãƒˆã«ãªã‚‹å ´åˆãŒã‚ã‚‹
          ref: ${{ github.event.workflow_run.head_sha || github.sha }}

      # -----------------------------------------------------------------------
      # 2. PHP ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      # -----------------------------------------------------------------------
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          extensions: mbstring, xml, zip
          tools: composer:v2

      # -----------------------------------------------------------------------
      # 3. Node.js ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      # -----------------------------------------------------------------------
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      # -----------------------------------------------------------------------
      # 4. Composerä¾å­˜ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼ˆæœ¬ç•ªç”¨ï¼‰
      # -----------------------------------------------------------------------
      - name: Install Composer dependencies (production)
        run: composer install --no-dev --optimize-autoloader --no-interaction

      # -----------------------------------------------------------------------
      # 5. npmä¾å­˜ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      # -----------------------------------------------------------------------
      - name: Install npm dependencies
        run: npm ci

      # -----------------------------------------------------------------------
      # 6. ã‚¢ã‚»ãƒƒãƒˆãƒ“ãƒ«ãƒ‰
      # -----------------------------------------------------------------------
      - name: Build assets
        run: npm run build

      # -----------------------------------------------------------------------
      # 7. ãƒãƒ¼ã‚¸ãƒ§ãƒ³å–å¾—
      # -----------------------------------------------------------------------
      - name: Get plugin version
        id: version
        run: |
          VERSION=$(grep -oP "Version:\s*\K[0-9.]+" ${{ env.PLUGIN_SLUG }}.php || echo "0.0.0")
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Plugin version: $VERSION"

      # -----------------------------------------------------------------------
      # 8. DEV ZIPä½œæˆï¼ˆtools/è¾¼ã¿ï¼‰
      # -----------------------------------------------------------------------
      - name: Create dev ZIP package
        run: |
          mkdir -p dist/${{ env.PLUGIN_SLUG }}
          
          # å¿…è¦ãªãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚³ãƒ”ãƒ¼ï¼ˆtools/ã‚’å«ã‚€ï¼‰
          rsync -av --progress \
            --exclude='.git' \
            --exclude='.github' \
            --exclude='.gitignore' \
            --exclude='.gitattributes' \
            --exclude='node_modules' \
            --exclude='vendor' \
            --exclude='tests' \
            --exclude='phpunit.xml*' \
            --exclude='phpcs.xml*' \
            --exclude='.phpcs.xml*' \
            --exclude='composer.lock' \
            --exclude='package-lock.json' \
            --exclude='.editorconfig' \
            --exclude='.eslintrc*' \
            --exclude='.stylelintrc*' \
            --exclude='*.map' \
            --exclude='*.scss' \
            --exclude='gulpfile.js' \
            --exclude='webpack.config.js' \
            --exclude='bin/' \
            --exclude='/dist/' \
            --exclude='.claude/' \
            --exclude='ARCHITECTURE.md' \
            --exclude='CLAUDE.md' \
            --exclude='docs/' \
            ./ dist/${{ env.PLUGIN_SLUG }}/
          
          # ZIPä½œæˆ
          cd dist
          zip -r ${{ env.PLUGIN_SLUG }}-v${{ steps.version.outputs.version }}-dev.zip ${{ env.PLUGIN_SLUG }}
          
          echo "Created: ${{ env.PLUGIN_SLUG }}-v${{ steps.version.outputs.version }}-dev.zip"
          ls -lh *.zip

      # -----------------------------------------------------------------------
      # 9. AWSèªè¨¼
      # -----------------------------------------------------------------------
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      # -----------------------------------------------------------------------
      # 10. S3ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
      # -----------------------------------------------------------------------
      - name: Upload to S3 (dev)
        run: |
          aws s3 cp \
            dist/${{ env.PLUGIN_SLUG }}-v${{ steps.version.outputs.version }}-dev.zip \
            s3://${{ secrets.AWS_S3_BUCKET }}/aivec/plugins/${{ env.PLUGIN_SLUG }}/dev/${{ env.PLUGIN_SLUG }}-v${{ steps.version.outputs.version }}-dev.zip
          
          aws s3 cp \
            dist/${{ env.PLUGIN_SLUG }}-v${{ steps.version.outputs.version }}-dev.zip \
            s3://${{ secrets.AWS_S3_BUCKET }}/aivec/plugins/${{ env.PLUGIN_SLUG }}/dev/${{ env.PLUGIN_SLUG }}-latest-dev.zip

      # -----------------------------------------------------------------------
      # 11. ã‚µãƒžãƒªãƒ¼å‡ºåŠ›
      # -----------------------------------------------------------------------
      - name: Output summary
        run: |
          echo "## ðŸš€ Dev Build Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Item | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Version | ${{ steps.version.outputs.version }}-dev |" >> $GITHUB_STEP_SUMMARY
          echo "| S3 Path | \`s3://${{ secrets.AWS_S3_BUCKET }}/${{ env.PLUGIN_SLUG }}/dev/\` |" >> $GITHUB_STEP_SUMMARY
          echo "| File | ${{ env.PLUGIN_SLUG }}-v${{ steps.version.outputs.version }}-dev.zip |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Includes \`tools/\` directory for testing" >> $GITHUB_STEP_SUMMARY
